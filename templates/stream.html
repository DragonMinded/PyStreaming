<!DOCTYPE html>
<html lang="en">
  <head>
      <title>{{ streamer }}'s Stream</title>
      <style>
        html {
          width: 100vw;
          height: 100vh;
          margin: 0px;
        }
        body {
          width: 100vw;
          height: 100vh;
          margin: 0px;
        }
        div.content {
          width: 100vw;
          height: 100vh;
          display: table;
        }
        div.content-inner {
          width: 100vw;
          height: 100vh;
          display: table-row;
        }
        div.stream {
          display: table-cell;
          height: 100vh;
        }
        div.chat {
          display: table-cell;
          width: 250px;
          height: 100vh;
          padding-left: 5px;
          padding-right: 5px;
        }
        .video-js {
          width: 100%;
          height: 100%;
        }
        div.error {
          color: red;
        }
        div.username-prompt {
          padding-bottom: 15px;
          font-style: italic;
        }
        form {
          width: 100%;
          margin-top: 5px;
          margin-bottom: 5px;
          justify-content: end;
          display: flex;
          flex-direction: column;
        }
        div.chat-inner {
          float: left;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: end;
        }
        div.messages {
          width: 100%;
          max-height: 100%;
          overflow-y: auto;
        }
      </style>
      <link href="https://vjs.zencdn.net/7.5.5/video-js.css" rel="stylesheet" />
  </head>

  <body>
    <div class="content">
      <div class="content-inner">
          <div class="stream">
            <video
              id="my-video"
              class="video-js"
              controls
              autoplay
              preload="auto"
              data-setup="{}"
            >
              <source src="/{{streamer}}/playlist.m3u8" type="application/x-mpegURL" />
              <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
              </p>
            </video>
            <script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
          </div>
          <div class="chat">
            <div class="chat-inner" id="login-frame">
              <form action="" method="POST" id="login">
                <div class="username-prompt">choose a user name</div>
                <input type="text" class="username" placeholder="User Name"/>
                <input type="submit" value="Connect"/>
                <div class="error"></div>
              </form>
            </div>

            <div class="chat-inner" id="admin-frame" style="display: none">
              <form action="" method="POST" id="admin">
                <div class="username-prompt">authenticate for admin access</div>
                <input type="password" class="password" id="password"/>
                <input type="submit" value="Authenticate"/>
                <div class="error"></div>
              </form>
            </div>

            <div class="chat-inner" id="chat-frame" style="display: none">
              <form action="" method="POST" id="chat">
                <div class="messages"></div>
                <input type="text" class="message" id="message" autocomplete="off" placeholder="Type a message..."/>
                <input type="submit" value="Send"/>
                <div class="error"></div>
              </form>
            </div>

            <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
            <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
            <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
            <script type="text/javascript">
              $( '#login' ).on( 'submit', function( e ) {
                e.preventDefault();
              } );

              $( '#chat' ).on( 'submit', function( e ) {
                e.preventDefault();
              } );

              var add = function( inner ) {
                var box = $( 'div.messages' );
                var scroll = box[0].scrollTop == box[0].scrollTopMax;

                box.append( inner );
                if (scroll) {
                  box[0].scrollTop = box[0].scrollTopMax;
                }
              }

              var socket = io.connect(location.protocol  + '//' + document.domain + ':' + location.port);
              var username = undefined;
              var streamer = {{ streamer|tojson|safe }}
              var connected = false;
              var users = []; 

              socket.on( 'connect', function() {
                $( 'div.error' ).text( '' );
                $( '#login' ).on( 'submit', function( e ) {
                  e.preventDefault();

                  username = $( 'input.username' ).val();
                  socket.emit( 'login', {
                    username : username,
                    streamer : streamer, 
                  } );
                } );
              } );

              socket.on( 'login key required', function( msg ) {
                username = msg.username;

                $( 'div.error' ).text( '' );
                $( '#login-frame' ).remove();
                $( '#admin-frame' ).show();
                $( '#password' ).focus()

                $( '#admin' ).on( 'submit', function( e ) {
                  e.preventDefault();

                  let password = $( 'input.password' ).val();
                  socket.emit( 'login', {
                    streamer : streamer,
                    username : username,
                    key : password,
                  } );
                } );
              });

              socket.on( 'login success', function( msg ) {
                username = msg.username;

                $( 'div.error' ).text( '' );
                $( '#login-frame' ).remove();
                $( '#chat-frame' ).show();
                $( '#message' ).focus()

                $( '#chat' ).on( 'submit', function( e ) {
                  e.preventDefault();

                  let message = $( 'input.message' ).val();
                  $( 'input.message' ).val( '' );

                  if( message == "/users" ) {
                    add( '<div><b style="color: #000">Connected users:</b> '+users.join(', ') +'</div>' );
                  }
                  else if( message == "/help" ) {
                    add( '<div style="color: #f00">The following commands are recognized:</div>' );
                    add( '<div style="color: #f00">/help - show this message</div>' );
                    add( '<div style="color: #f00">/users - show the currently chatting users</div>' );
                  }
                  else {
                    socket.emit( 'message', {
                      message : message,
                    } );
                  }
                } );
              });

              socket.on( 'connected', function( msg ) {
                if( connected ) {
                  add( '<div><b style="color: #000">'+msg.username+' joined!</b></div>' );
                }
                if( msg.username == username && !connected ) {
                  add( '<div><b style="color: #000">Connected users:</b> '+msg.users.join(', ') +'</div>' );
                  connected = true;
                }
                users = msg.users;
              })

              socket.on( 'server', function( msg ) {
                add( '<div><b style="color: #f00">'+msg.msg+'</b></div>' );
              })

              socket.on( 'disconnected', function( msg ) {
                if( connected ) {
                  add( '<div><b style="color: #000">'+msg.username+' left!</b></div>' );
                }
                users = msg.users;
              })

              socket.on( 'message received', function( msg ) {
                if( connected ) {
                  if( msg.username == username ) {
                    $( 'div.error' ).text( '' );
                  }
                  add( '<div><b style="color: #000">'+msg.username+':</b> '+msg.message+'</div>' );
                }
              })

              socket.on( 'error', function( msg ) {
                $( 'div.error' ).text( msg.msg );
                console.log( msg.msg );
              } );

              socket.on( 'warning', function( msg ) {
                console.log( msg.msg );
              } );
            </script>
          </div>
      </div>
    </div>
  </body>
</html>
